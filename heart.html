<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå½©çƒŸèŠ±å‘Šç™½</title>
    <link rel="stylesheet" href="css/heart.css">
</head>
<body>
    <div class="input-box">
        <input type="text" id="name" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" autocomplete="off" aria-label="ä½ çš„åå­—">
        <button id="launchBtn">ğŸ’– ç‚¹å‡»å¼€å¯æµªæ¼«ä¹‹æ—… ğŸ’–</button>
    </div>
    <div class="message" id="message" aria-live="polite"></div>
    <canvas id="canvas"></canvas>
    <div id="letter" role="dialog" aria-labelledby="letter-title" aria-modal="true"></div>
    <button class="sound-toggle" id="soundToggle" aria-label="åˆ‡æ¢éŸ³æ•ˆ">ğŸ”Š</button>

    <script src="js/heart.js"></script>
                setTimeout(() => {
                    letterEl.classList.add('open');
                }, 100);
            },

            renderLetterPage(name, letterEl) {
                const isLastPage = this.currentPage === this.totalPages - 1;
                
                letterEl.innerHTML = `
                    <div class="letter-content">
                        <h2 id="letter-title">ç»™${name}çš„æƒ…ä¹¦ ${this.currentPage + 1}/${this.totalPages}</h2>
                        <p id="paragraph">
                            <span class="text-container" id="text-container"></span>
                        </p>
                        <div class="letter-nav">
                            <button class="nav-btn" id="prevBtn" ${this.currentPage === 0 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                            ${isLastPage ? 
                                '<div class="action-buttons">' +
                                '<button class="response-btn accept">ğŸ¥° æˆ‘æ„¿æ„</button>' +
                                '<button class="response-btn reject">ğŸ˜­ å†è€ƒè™‘</button>' +
                                '</div>' : 
                                '<button class="nav-btn" id="nextBtn">ä¸‹ä¸€é¡µ</button>'
                            }
                        </div>
                    </div>
                `;

                // æ·»åŠ é€å­—æ·¡å…¥æ•ˆæœ
                this.typeText(this.letterContent[this.currentPage], true);

                // æ·»åŠ å¯¼èˆªäº‹ä»¶
                if (this.currentPage > 0) {
                    document.getElementById('prevBtn').addEventListener('click', () => {
                        if (this.isAnimating) return;
                        this.navigateToPage(name, letterEl, -1);
                    });
                }

                if (!isLastPage) {
                    document.getElementById('nextBtn').addEventListener('click', () => {
                        if (this.isAnimating) return;
                        this.navigateToPage(name, letterEl, 1);
                    });
                }

                // æ·»åŠ é€‰æ‹©æŒ‰é’®äº‹ä»¶
                if (isLastPage) {
                    document.querySelectorAll('.response-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const response = e.target.classList.contains('accept') ?
                                'â¤ï¸ ä½™ç”Ÿè¯·å¤šæŒ‡æ•™ï¼' : 'ğŸ’” æˆ‘ä¼šç»§ç»­åŠªåŠ›ï¼';
                            
                            // å…ˆå…³é—­æƒ…ä¹¦
                            letterEl.classList.remove('open');
                            letterEl.classList.add('close');
                            
                            // ç­‰å¾…å…³é—­åŠ¨ç”»å®Œæˆåæ˜¾ç¤ºå“åº”æ¶ˆæ¯
                            setTimeout(() => {
                                this.showResponseMessage(response);
                                this.createRippleEffect(letterEl);
                                setTimeout(() => letterEl.remove(), 2000);
                            }, 1000);
                        });
                    });
                }
            },

            // é€å­—æ·¡å…¥æ·¡å‡ºæ•ˆæœ
            typeText(text, isFadeIn) {
                const textContainer = document.getElementById('text-container');
                textContainer.innerHTML = '';
                
                // å°†æ–‡æœ¬æ‹†åˆ†ä¸ºå­—ç¬¦
                const chars = text.split('');
                
                chars.forEach((char, index) => {
                    const span = document.createElement('span');
                    span.className = 'char';
                    span.textContent = char;
                    
                    // è®¾ç½®æ¯ä¸ªå­—ç¬¦çš„å»¶è¿Ÿ
                    const delay = index * 30; // æ¯ä¸ªå­—ç¬¦å»¶è¿Ÿ30msï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰
                    
                    if (isFadeIn) {
                        // æ·¡å…¥æ•ˆæœ
                        setTimeout(() => {
                            span.classList.add('show');
                        }, delay);
                    } else {
                        // æ·¡å‡ºæ•ˆæœ
                        span.classList.add('show');
                        setTimeout(() => {
                            span.classList.remove('show');
                            span.classList.add('hide');
                        }, delay);
                    }
                    
                    textContainer.appendChild(span);
                });
            },

            navigateToPage(name, letterEl, direction) {
                this.isAnimating = true;
                
                // å…ˆæ·¡å‡ºå½“å‰æ–‡æœ¬
                this.typeText(this.letterContent[this.currentPage], false);
                
                // è®¡ç®—æ·¡å‡ºå®Œæˆçš„æ—¶é—´ï¼ˆåŠ å¿«é€Ÿåº¦ï¼‰
                const textLength = this.letterContent[this.currentPage].length;
                const fadeOutTime = textLength * 30 + 200; // æ·¡å‡ºæ€»æ—¶é—´ + é¢å¤–ç¼“å†²
                
                // åœ¨æ·¡å‡ºè¿›è¡Œåˆ°ä¸€åŠæ—¶å¼€å§‹æ·¡å…¥ä¸‹ä¸€é¡µ
                setTimeout(() => {
                    // æ›´æ–°é¡µé¢
                    this.currentPage += direction;
                    
                    // æ›´æ–°é¡µé¢å†…å®¹ä½†ä¸ç«‹å³æ˜¾ç¤º
                    const isLastPage = this.currentPage === this.totalPages - 1;
                    
                    letterEl.innerHTML = `
                        <div class="letter-content">
                            <h2 id="letter-title">ç»™${name}çš„æƒ…ä¹¦ ${this.currentPage + 1}/${this.totalPages}</h2>
                            <p id="paragraph">
                                <span class="text-container" id="text-container"></span>
                            </p>
                            <div class="letter-nav">
                                <button class="nav-btn" id="prevBtn" ${this.currentPage === 0 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                                ${isLastPage ? 
                                    '<div class="action-buttons">' +
                                    '<button class="response-btn accept">ğŸ¥° æˆ‘æ„¿æ„</button>' +
                                    '<button class="response-btn reject">ğŸ˜­ å†è€ƒè™‘</button>' +
                                    '</div>' : 
                                    '<button class="nav-btn" id="nextBtn">ä¸‹ä¸€é¡µ</button>'
                                }
                            </div>
                        </div>
                    `;
                    
                    // æ·»åŠ å¯¼èˆªäº‹ä»¶
                    if (this.currentPage > 0) {
                        document.getElementById('prevBtn').addEventListener('click', () => {
                            if (this.isAnimating) return;
                            this.navigateToPage(name, letterEl, -1);
                        });
                    }
                    
                    if (!isLastPage) {
                        document.getElementById('nextBtn').addEventListener('click', () => {
                            if (this.isAnimating) return;
                            this.navigateToPage(name, letterEl, 1);
                        });
                    }
                    
                    // æ·»åŠ é€‰æ‹©æŒ‰é’®äº‹ä»¶
                    if (isLastPage) {
                        document.querySelectorAll('.response-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const response = e.target.classList.contains('accept') ?
                                    'â¤ï¸ ä½™ç”Ÿè¯·å¤šæŒ‡æ•™ï¼' : 'ğŸ’” æˆ‘ä¼šç»§ç»­åŠªåŠ›ï¼';
                                
                                // å…ˆå…³é—­æƒ…ä¹¦
                                letterEl.classList.remove('open');
                                letterEl.classList.add('close');
                                
                                // ç­‰å¾…å…³é—­åŠ¨ç”»å®Œæˆåæ˜¾ç¤ºå“åº”æ¶ˆæ¯
                                setTimeout(() => {
                                    this.showResponseMessage(response);
                                    this.createRippleEffect(letterEl);
                                    setTimeout(() => letterEl.remove(), 2000);
                                }, 1000);
                            });
                        });
                    }
                    
                    // å¼€å§‹æ·¡å…¥æ–°æ–‡æœ¬
                    this.typeText(this.letterContent[this.currentPage], true);
                    
                    // æ’­æ”¾ç¿»é¡µéŸ³æ•ˆ
                    soundSystem.playPageTurn();
                    
                    // é‡ç½®åŠ¨ç”»çŠ¶æ€
                    setTimeout(() => {
                        this.isAnimating = false;
                    }, textLength * 30 + 200); // ç­‰å¾…æ–°æ–‡æœ¬æ·¡å…¥å®Œæˆ
                }, fadeOutTime / 2); // åœ¨æ·¡å‡ºè¿›è¡Œåˆ°ä¸€åŠæ—¶å¼€å§‹æ·¡å…¥
            },

            showResponseMessage(text) {
                const el = document.createElement('div');
                el.className = 'message';
                el.textContent = text;
                document.body.appendChild(el);
                el.style.opacity = 1;
                
                // æ’­æ”¾ç›¸åº”éŸ³æ•ˆ
                if (text.includes('ä½™ç”Ÿ')) {
                    soundSystem.playSuccess();
                }
                
                setTimeout(() => {
                    el.style.opacity = 0;
                    setTimeout(() => el.remove(), 1000);
                }, 2000);
            },

            createRippleEffect(target) {
                const ripple = document.createElement('div');
                ripple.className = 'ripple';
                ripple.style.left = `${target.offsetLeft + target.offsetWidth/2}px`;
                ripple.style.top = `${target.offsetTop + target.offsetHeight/2}px`;
                document.body.appendChild(ripple);
                setTimeout(() => ripple.remove(), 1500);
            }
        };

        // åˆå§‹åŒ–ç³»ç»Ÿ
        const soundSystem = new SoundSystem();
        const starBackground = new StarBackground();
        const fireworkSystem = new FireworkSystem();
        const heartParticleSystem = new HeartParticleSystem();
        eventHandler.init();
        animate();
    </script>
</body>
</html>